var SelectionMenu=function(h,f){function i(a,b,d){if(a.addEventListener)a.addEventListener(b,d,false);else a.attachEvent&&a.attachEvent("on"+b,function(){return d.call(a,h.event)})}function k(){return h.getSelection?h.getSelection():f.selection&&f.selection.createRange?f.selection.createRange():false}function l(a){return a.toString?a.toString():a.text}function n(a,b){return a.compareDocumentPosition?!!(a.compareDocumentPosition(b)&16):a.contains(b)}function m(a){a=a.target||a.srcElement;return a== c||n(c,a)}function j(a){this.menuHTML=a.menuHTML;this.minimalSelection=a.minimalSelection||5;this.container=a.container;this.handler=a.handler;this.create();this.setupEvents()}var c=null;j.addEvent=i;j.prototype={create:function(){if(!c){c=f.createElement("span");c.id="selection-menu"}},setupEvents:function(){var a=this,b=a.container;i(b,"mousedown",function(d){a.hide(d)});i(b,"mouseup",function(d){a.insert(d);h.setTimeout(function(){a.hideIfNoSelection()},0)});a.setupMenuEvents()},setupMenuEvents:function(){var a= this;i(c,"click",function(b){a.handler.call(a,b);return false});c.unselectable=true},hide:function(a){if(!(a&&m(a)))(a=c.parentNode)&&a.removeChild(c)},hideIfNoSelection:function(){var a=k();if(a)l(a).length||this.hide()},insert:function(a){if(!m(a)){var b=k();if(b){var d=l(b);this.selectedText=d;if(d.length<this.minimalSelection)this.hide(a);else{if(b.getRangeAt){a=b.getRangeAt(0);d=f.createRange();var g=a.startContainer,e=a.endContainer;if(!(g&&e&&g.compareDocumentPosition))return;if(g.compareDocumentPosition(e)& 2)e=a.startContainer;g=a.endOffset;if(e.nodeType==1){e=e.lastChild;if(!e||e.nodeType!=3)return;g=e.data.length}d.setStart(e,g);c.innerHTML=this.menuHTML;d.insertNode(c);b.removeRange?b.removeRange(a):b.removeAllRanges();b.addRange(a)}else if(b.duplicate){d=b.duplicate();d.setEndPoint("StartToEnd",b);c.innerHTML=this.menuHTML;d.pasteHTML(c.outerHTML);b.select();c=f.getElementById("selection-menu");this.setupMenuEvents()}else return;this.position()}}}},position:function(){c.style.marginTop=-(c.offsetHeight+ 5)+"px"}};return j}(window,document);